(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{582:function(v,i,t){"use strict";t.r(i);var _=t(10),a=Object(_.a)({},(function(){var v=this,i=v.$createElement,t=v._self._c||i;return t("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[t("h2",{attrs:{id:"javascript-如何运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#javascript-如何运行"}},[v._v("#")]),v._v(" javascript 如何运行")]),v._v(" "),t("h3",{attrs:{id:"_1-1-浏览器内核"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-浏览器内核"}},[v._v("#")]),v._v(" 1.1 浏览器内核")]),v._v(" "),t("p",[v._v("我们经常会说：不同的浏览器有不同的内核组成")]),v._v(" "),t("ul",[t("li",[v._v("Gecko：早期被 Netscape 和 Mozilla Firefox 浏览器浏览器使用；")]),v._v(" "),t("li",[v._v("Trident：微软开发，被 IE4~IE11 浏览器使用，但是 Edge 浏览器已经转向 Blink；")]),v._v(" "),t("li",[v._v("Webkit：苹果基于 KHTML 开发、开源的，用于 Safari，Google Chrome 之前也在使用；")]),v._v(" "),t("li",[v._v("Blink：是 Webkit 的一个分支，Google 开发，目前应用于 Google Chrome、Edge、Opera 等；")]),v._v(" "),t("li",[v._v("等等...")])]),v._v(" "),t("p",[v._v("事实上，我们经常说的浏览器内核指的是浏览器的排版引擎：")]),v._v(" "),t("ul",[t("li",[t("strong",[v._v("排版引擎")]),v._v("（layout engine），也称为"),t("strong",[v._v("浏览器引擎")]),v._v("（browser engine）、"),t("strong",[v._v("页面渲染引擎")]),v._v("（rendering engine）或"),t("strong",[v._v("样版引擎")]),v._v("。")])]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141615873.webp",alt:"WebKit main flow"}})]),v._v(" "),t("p",[v._v("但是在这个执行过程中，HTML 解析的时候遇到了 JavaScript 标签，应该怎么办呢？")]),v._v(" "),t("ul",[t("li",[v._v("会停止解析 HTML，而去加载和执行 JavaScript 代码；")])]),v._v(" "),t("p",[v._v("当然，为什么不直接异步去加载执行 JavaScript 代码，而要在这里停止掉呢？")]),v._v(" "),t("ul",[t("li",[v._v("这是因为 JavaScript 代码可以操作我们的 DOM；")]),v._v(" "),t("li",[v._v("所以浏览器希望将 HTML 解析的 DOM 和 JavaScript 操作之后的 DOM 放到一起来生成最终的 DOM 树，而不是频繁的去生成新的 DOM 树；")])]),v._v(" "),t("p",[v._v("那么，JavaScript 代码由谁来执行呢？")]),v._v(" "),t("ul",[t("li",[v._v("JavaScript 引擎")])]),v._v(" "),t("h3",{attrs:{id:"_1-2-javascript-引擎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-javascript-引擎"}},[v._v("#")]),v._v(" 1.2. JavaScript 引擎")]),v._v(" "),t("p",[v._v("为什么需要 JavaScript 引擎呢？")]),v._v(" "),t("ul",[t("li",[v._v("事实上我们编写的 JavaScript 无论你交给浏览器或者 Node 执行，最后都是需要被 CPU 执行的；")]),v._v(" "),t("li",[v._v("但是 CPU 只认识自己的指令集，实际上是机器语言，才能被 CPU 所执行；")]),v._v(" "),t("li",[v._v("所以我们需要 JavaScript 引擎帮助我们将 JavaScript 代码翻译成 CPU 指令来执行；")])]),v._v(" "),t("p",[v._v("比较常见的 JavaScript 引擎有哪些呢？")]),v._v(" "),t("ul",[t("li",[t("strong",[v._v("SpiderMonkey")]),v._v("：第一款 JavaScript 引擎，由 Brendan Eich 开发（也就是 JavaScript 作者）；")]),v._v(" "),t("li",[t("strong",[v._v("Chakra")]),v._v("：微软开发，用于 IT 浏览器；")]),v._v(" "),t("li",[t("strong",[v._v("JavaScriptCore")]),v._v("：WebKit 中的 JavaScript 引擎，Apple 公司开发；")]),v._v(" "),t("li",[t("strong",[v._v("V8")]),v._v("：Google 开发的强大 JavaScript 引擎，也帮助 Chrome 从众多浏览器中脱颖而出；")])]),v._v(" "),t("p",[v._v("这里我们先以 WebKit 为例，WebKit 事实上由两部分组成的：")]),v._v(" "),t("ul",[t("li",[v._v("WebCore：负责 HTML 解析、布局、渲染等等相关的工作；")]),v._v(" "),t("li",[v._v("JavaScriptCore：解析、执行 JavaScript 代码；")])]),v._v(" "),t("p",[v._v("看到这里，学过小程序的同学有没有感觉非常的熟悉呢？")]),v._v(" "),t("ul",[t("li",[v._v("在小程序中编写的 JavaScript 代码就是被 JSCore 执行的；")])]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141616034.webp",alt:"图片"}})]),v._v(" "),t("p",[v._v("另外一个强大的 JavaScript 引擎就是 V8 引擎。")]),v._v(" "),t("h3",{attrs:{id:"_1-4-v8-引擎"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-v8-引擎"}},[v._v("#")]),v._v(" 1.4. V8 引擎")]),v._v(" "),t("p",[v._v("我们来看一下官方对 V8 引擎的定义：")]),v._v(" "),t("ul",[t("li",[v._v("V8 是用 C ++编写的 Google 开源高性能 JavaScript 和 WebAssembly 引擎，它用于 Chrome 和 Node.js 等。")]),v._v(" "),t("li",[v._v("它实现 ECMAScript 和 WebAssembly，并在 Windows 7 或更高版本，macOS 10.12+和使用 x64，IA-32，ARM 或 MIPS 处理器的 Linux 系统上运行。")]),v._v(" "),t("li",[v._v("V8 可以独立运行，也可以嵌入到任何 C ++应用程序中。")])]),v._v(" "),t("p",[v._v("V8 引擎本身的源码非常复杂，大概有超过 100w 行 C++代码，但是我们可以简单了解一下它执行 JavaScript 代码的原理：")]),v._v(" "),t("ul",[t("li",[t("p",[v._v("Parse 模块会将 JavaScript 代码转换成 AST（抽象语法树），这是因为解释器并不直接认识 JavaScript 代码；")])]),v._v(" "),t("li",[t("ul",[t("li",[v._v("如果函数没有被调用，那么是不会被转换成 AST 的；")]),v._v(" "),t("li",[v._v("Parse 的 V8 官方文档：https://v8.dev/blog/scanner")])])]),v._v(" "),t("li",[t("p",[v._v("Ignition 是一个解释器，会将 AST 转换成 ByteCode（字节码）")])]),v._v(" "),t("li",[t("ul",[t("li",[v._v("同时会收集 TurboFan 优化所需要的信息（比如函数参数的类型信息，有了类型才能进行真实的运算）；")]),v._v(" "),t("li",[v._v("如果函数只调用一次，Ignition 会执行解释执行 ByteCode；")]),v._v(" "),t("li",[v._v("Ignition 的 V8 官方文档：https://v8.dev/blog/ignition-interpreter")])])]),v._v(" "),t("li",[t("p",[v._v("TurboFan 是一个编译器，可以将字节码编译为 CPU 可以直接执行的机器码；")])]),v._v(" "),t("li",[t("ul",[t("li",[v._v("如果一个函数被多次调用，那么就会被标记为热点函数，那么就会经过 TurboFan 转换成优化的机器码，提高代码的执行性能；")]),v._v(" "),t("li",[v._v("但是，机器码实际上也会被还原为 ByteCode，这是因为如果后续执行函数的过程中，类型发生了变化（比如 sum 函数原来执行的是 number 类型，后来执行变成了 string 类型），之前优化的机器码并不能正确的处理运算，就会逆向的转换成字节码；")]),v._v(" "),t("li",[v._v("TurboFan 的 V8 官方文档：https://v8.dev/blog/turbofan-jit")])])])]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141616593.webp",alt:"图片"}})]),v._v(" "),t("p",[v._v("上面是 JavaScript 代码的执行过程，事实上 V8 的内存回收也是其强大的另外一个原因，这里暂时先不展开讨论：")]),v._v(" "),t("ul",[t("li",[v._v("Orinoco 模块，负责垃圾回收，将程序中不需要的内存回收；")]),v._v(" "),t("li",[v._v("Orinoco 的 V8 官方文档：https://v8.dev/blog/trash-talk")])]),v._v(" "),t("h2",{attrs:{id:"二-邂逅-node-js"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-邂逅-node-js"}},[v._v("#")]),v._v(" 二. 邂逅 Node.js")]),v._v(" "),t("h3",{attrs:{id:"_2-1-node-js-是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-node-js-是什么"}},[v._v("#")]),v._v(" 2.1. Node.js 是什么？")]),v._v(" "),t("p",[v._v("回顾：官方对 Node.js 的定义：")]),v._v(" "),t("ul",[t("li",[v._v("Node.js 是一个基于 V8 JavaScript 引擎的 JavaScript 运行时环境。")])]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141618196.webp",alt:"图片"}})]),v._v(" "),t("p",[v._v("也就是说 Node.js 基于 V8 引擎来执行 JavaScript 的代码，但是不仅仅只有 V8 引擎：")]),v._v(" "),t("ul",[t("li",[v._v("前面我们知道 Node.js 可以嵌入到任何 C ++应用程序中，无论是 Chrome 还是 Node.js，事实上都是嵌入了 V8 引擎来执行 JavaScript 代码；")]),v._v(" "),t("li",[v._v("但是在 Chrome 浏览器中，还需要解析、渲染 HTML、CSS 等相关渲染引擎，另外还需要提供支持浏览器操作的 API、浏览器自己的事件循环等；")]),v._v(" "),t("li",[v._v("另外，在 Node.js 中我们也需要进行一些额外的操作，比如文件系统读/写、网络 IO、加密、压缩解压文件等操作；")])]),v._v(" "),t("p",[v._v("所以，我们可以简单理解规划出 Node.js 和浏览器的差异：")]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141618173.webp",alt:"图片"}}),v._v("Chrome 浏览器和 Node 架构区别")]),v._v(" "),t("p",[v._v("这里也有一份单独的 Node.js 的架构图：")]),v._v(" "),t("ul",[t("li",[v._v("我们编写的 JavaScript 代码会经过 V8 引擎，再通过 Node.js 的 Bindings，将任务放到 Libuv 的事件循环中；")]),v._v(" "),t("li",[t("strong",[v._v("libuv")]),v._v("（Unicorn Velociraptor—独角伶盗龙）是使用 C 语言编写的库；")]),v._v(" "),t("li",[v._v("libuv 提供了事件循环、文件系统读写、网络 IO、线程池等等内容；")])]),v._v(" "),t("p",[t("img",{attrs:{src:"http://img.viini.cn/img/202112141618179.webp",alt:"图片"}})])])}),[],!1,null,null,null);i.default=a.exports}}]);